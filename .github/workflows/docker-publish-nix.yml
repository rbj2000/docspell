name: Docker Publish (Nix)

on:
  push:
    branches:
      - 'master'      # Stable releases
      - 'develop'     # Nightly builds
    tags:
      - 'v*'          # Version tags

jobs:
  docker-publish-nix:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          # Remove unnecessary software to free up ~30GB
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine version tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "tag=${VERSION}" >> $GITHUB_OUTPUT
            echo "latest=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "latest=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "tag=nightly" >> $GITHUB_OUTPUT
            echo "latest=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and push restserver image
        env:
          DOCKER_REPO: ${{ secrets.DOCKER_USERNAME }}
          VERSION_TAG: ${{ steps.version.outputs.tag }}
          PUSH_LATEST: ${{ steps.version.outputs.latest }}
        run: |
          echo "Building restserver..."
          nix build .#legacyPackages.x86_64-linux.docker.amd64.docspell-restserver

          echo "Loading and pushing restserver..."
          docker load < result
          RESTSERVER_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep docspell-restserver | head -1)
          docker tag $RESTSERVER_IMAGE $DOCKER_REPO/docspell-restserver:$VERSION_TAG
          docker push $DOCKER_REPO/docspell-restserver:$VERSION_TAG

          if [ "$PUSH_LATEST" = "true" ]; then
            docker tag $RESTSERVER_IMAGE $DOCKER_REPO/docspell-restserver:latest
            docker push $DOCKER_REPO/docspell-restserver:latest
          fi

          # Cleanup to free disk space
          rm -rf result
          docker image rm $RESTSERVER_IMAGE || true
          nix-collect-garbage -d

      - name: Build and push joex image
        env:
          DOCKER_REPO: ${{ secrets.DOCKER_USERNAME }}
          VERSION_TAG: ${{ steps.version.outputs.tag }}
          PUSH_LATEST: ${{ steps.version.outputs.latest }}
        run: |
          echo "Building joex..."
          nix build .#legacyPackages.x86_64-linux.docker.amd64.docspell-joex

          echo "Loading and pushing joex..."
          docker load < result
          JOEX_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep docspell-joex | head -1)
          docker tag $JOEX_IMAGE $DOCKER_REPO/docspell-joex:$VERSION_TAG
          docker push $DOCKER_REPO/docspell-joex:$VERSION_TAG

          if [ "$PUSH_LATEST" = "true" ]; then
            docker tag $JOEX_IMAGE $DOCKER_REPO/docspell-joex:latest
            docker push $DOCKER_REPO/docspell-joex:latest
          fi

          # Cleanup
          rm -rf result
          docker image rm $JOEX_IMAGE || true

      - name: Image summary
        run: |
          echo "Published images:"
          echo "- ${{ secrets.DOCKER_USERNAME }}/docspell-restserver:${{ steps.version.outputs.tag }}"
          echo "- ${{ secrets.DOCKER_USERNAME }}/docspell-joex:${{ steps.version.outputs.tag }}"
